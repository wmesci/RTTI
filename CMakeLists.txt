cmake_minimum_required(VERSION 3.5)

SET(TARGET_NAME RTTI)

PROJECT(${TARGET_NAME})

SET(CMAKE_CXX_STANDARD 20)
SET(CMAKE_CXX_STANDARD_REQUIRED ON)

FILE(GLOB_RECURSE RTTI_SOURCE src/*.cpp)

SET(TARGET_SOURCE ${RTTI_SOURCE})

IF (CMAKE_CXX_COMPILER_ID MATCHES "Clang")
    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fno-rtti -fno-exceptions -ffunction-sections -fdata-sections -flto -fvisibility=hidden")
ELSEIF (CMAKE_CXX_COMPILER_ID MATCHES "MSVC")
    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /utf-8 /bigobj /arch:AVX /Zc:preprocessor /Ot /Oi /Qpar /GS /sdl /fp:fast /wd4819 /wd4267 /wd4244 /wd4800 /wd4305 /wd4309")
ENDIF()

IF(WIN32)

    ADD_DEFINITIONS(-DUNICODE)
    ADD_DEFINITIONS(-D_UNICODE)

ELSE()

    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -stdlib=libc++ -I/usr/include -I/usr/local/include")

ENDIF()

ADD_LIBRARY(${TARGET_NAME} STATIC ${TARGET_SOURCE})

TARGET_INCLUDE_DIRECTORIES(${TARGET_NAME} PUBLIC ${PROJECT_SOURCE_DIR}/src)

# for test
OPTION(BUILD_TEST "Built RTTI Test" ON)

IF(BUILD_TEST)
    ADD_EXECUTABLE(${TARGET_NAME}-Test test.cpp)

    TARGET_LINK_LIBRARIES(${TARGET_NAME}-Test ${TARGET_NAME})

    SET_TARGET_PROPERTIES(${TARGET_NAME}-Test
        PROPERTIES
        ARCHIVE_OUTPUT_DIRECTORY "${PROJECT_SOURCE_DIR}/bin/${Configuration}"
        LIBRARY_OUTPUT_DIRECTORY "${PROJECT_SOURCE_DIR}/bin/${Configuration}"
        RUNTIME_OUTPUT_DIRECTORY "${PROJECT_SOURCE_DIR}/bin/${Configuration}"
        OUTPUT_NAME ${TARGET_NAME}-Test
        VERSION 1.0 SOVERSION 0
    )
ENDIF()